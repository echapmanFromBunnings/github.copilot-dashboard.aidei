@page "/"
@rendermode InteractiveServer

@using System.IO
@using copiloty_stats_viewer.Services
@using copiloty_stats_viewer.Components
@inject DataService Data
@inject IJSRuntime JS

<PageTitle>Copilot Stats</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Copilot Stats Explorer</h1>
    @if (loadedCount > 0)
    {
        <a href="/api/pdf/download?costPerHour=@costPerHour&totalLicensedUsers=@totalLicensedUsers" class="btn btn-outline-primary" target="_blank">
            <span class="oi oi-document" aria-hidden="true"></span> Export PDF
        </a>
    }
</div>

<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">
            <span class="oi oi-data-transfer-upload" aria-hidden="true"></span> Data Source
        </h5>
    </div>
    <div class="card-body">
        <div class="d-flex flex-wrap align-items-center gap-3">
            <div class="input-file-wrapper">
                <button class="btn btn-primary">
                    <span class="oi oi-document" aria-hidden="true"></span> Select File
                </button>
                <InputFile OnChange="OnFileSelected" accept=".json,.ndjson,.txt" />
            </div>
            <button class="btn btn-outline-secondary" @onclick="LoadSample">
                <span class="oi oi-beaker" aria-hidden="true"></span> Load Sample Data
            </button>
            <div class="ms-auto d-flex align-items-center gap-2">
                <label class="form-label mb-0">Total Licensed Users:</label>
                <input type="number" class="form-control" style="width: 120px;" 
                       @bind="totalLicensedUsers" @bind:event="oninput" 
                       @onchange="OnLicensedUsersChanged" 
                       placeholder="0" min="0" />
                <button class="btn btn-outline-primary btn-sm ms-2" @onclick="ToggleSettings">
                    <span class="oi oi-cog" aria-hidden="true"></span> Settings
                </button>
            </div>
        </div>
        
        <!-- Configuration Settings Panel -->
        @if (showSettings)
        {
            <div class="border-top pt-3 mt-3">
                <h6 class="text-primary mb-3">
                    <span class="oi oi-cog" aria-hidden="true"></span> 
                    Metric Configuration Settings
                </h6>
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Time Saved per Acceptance</label>
                        <div class="input-group">
                            <input type="number" class="form-control" 
                                   @bind="timeSavedPerAcceptanceSeconds" 
                                   @oninput="OnTimeSavedChanged"
                                   min="1" max="300" step="1"
                                   data-bs-toggle="tooltip" 
                                   title="Average seconds saved per accepted code suggestion. Used for ROI calculations." />
                            <span class="input-group-text">sec</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Power User Acceptance Rate</label>
                        <div class="input-group">
                            <input type="number" class="form-control" 
                                   @bind="powerUserAcceptanceThreshold" 
                                   @oninput="OnPowerUserAcceptanceChanged"
                                   min="0.1" max="1.0" step="0.05"
                                   data-bs-toggle="tooltip" 
                                   title="Minimum acceptance rate required to classify a user as a power user." />
                            <span class="input-group-text">%</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Power User Active Days</label>
                        <input type="number" class="form-control" 
                               @bind="powerUserActiveDaysThreshold" 
                               @oninput="OnPowerUserDaysChanged"
                               min="1" max="30" step="1"
                               data-bs-toggle="tooltip" 
                               title="Minimum number of active days required to classify a user as a power user." />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Engagement Threshold</label>
                        <input type="number" class="form-control" 
                               @bind="engagementThreshold" 
                               @oninput="OnEngagementThresholdChanged"
                               min="1" max="50" step="1"
                               data-bs-toggle="tooltip" 
                               title="Minimum number of code acceptances required to consider a user as engaged." />
                    </div>
                </div>
                <div class="row g-3 mt-2">
                    <div class="col-md-3">
                        <label class="form-label">Cost per Developer Hour</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" 
                                   @bind="costPerHour" 
                                   @oninput="OnCostPerHourChanged"
                                   min="1" max="500" step="1"
                                   data-bs-toggle="tooltip" 
                                   title="Average cost per developer hour including salary, benefits, and overhead. Used for ROI and cost savings calculations." />
                        </div>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-12">
                        <small class="text-muted">
                            <span class="oi oi-info" aria-hidden="true"></span>
                            Changes to these settings will automatically recalculate all metrics. 
                            Default values are based on industry best practices.
                        </small>
                    </div>
                </div>
            </div>
        }
        </div>
        @if (isLoading)
        {
            <div class="mt-3">
                <div class="d-flex align-items-center gap-2">
                    <div class="spinner-border spinner-border-sm text-primary" role="status" aria-hidden="true"></div>
                    <span>Loading: @progressRecords records (@progressBytesDisplay / @totalBytesDisplay)</span>
                </div>
                <div class="progress mt-2" style="height: 8px;">
                    <div class="progress-bar" role="progressbar" style="width: @progressPercent%;" aria-valuenow="@progressPercent" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
            </div>
        }
        @if (!string.IsNullOrEmpty(loadError))
        {
            <div class="alert alert-danger mt-3" role="alert">
                <span class="oi oi-warning" aria-hidden="true"></span> @loadError
            </div>
        }
        @if (loadedCount > 0)
        {
            <div class="alert alert-success mt-3" role="alert">
                <span class="oi oi-check" aria-hidden="true"></span> Loaded @loadedCount records, spanning from @minDate.ToShortDateString() to @maxDate.ToShortDateString().
            </div>
        }
        else if (loadAttempted && !isLoading && string.IsNullOrEmpty(loadError))
        {
            <div class="alert alert-warning mt-3" role="alert">
                <span class="oi oi-info" aria-hidden="true"></span> No valid records found in the selected file.
            </div>
        }
        </div>

@if (loadedCount > 0)
{
    <!-- Metric Calculation Info Card -->
    <div class="alert alert-info mb-4" role="alert">
        <h6 class="alert-heading">
            <span class="oi oi-info" aria-hidden="true"></span> Metric Calculation Reference
        </h6>
        <div class="row">
            <div class="col-md-6">
                <strong>Working Days Metrics (Mon-Fri only):</strong>
                <ul class="mb-0 mt-1">
                    <li><strong>Usage Rate</strong> - Avg % of working days used</li>
                    <li><strong>Daily Acceptances/User</strong> - Per working day</li>
                    <li><strong>Productivity Cost Savings</strong> - Based on working days</li>
                </ul>
            </div>
            <div class="col-md-6">
                <strong>Calendar Days Metrics (All days in range):</strong>
                <ul class="mb-0 mt-1">
                    <li><strong>License Utilization</strong> - Any activity in period</li>
                    <li><strong>Engaged Users %</strong> - 2+ active days</li>
                    <li><strong>Adoption Rate</strong> - Any activity in period</li>
                </ul>
            </div>
        </div>
        <hr class="mt-2 mb-2">
        <small class="text-muted">
            <strong>Why different bases?</strong> Working days better reflect actual development time, 
            while calendar days capture weekend/on-call activity. Hover over any metric for detailed calculation info.
        </small>
    </div>

    <!-- Quick Wins KPI Cards -->
    <div class="mb-4">
        <h3 class="mb-3">
            <span class="oi oi-dashboard" aria-hidden="true"></span>
            Quick Wins Dashboard
        </h3>
        <div class="row mb-4">
            <div class="col-lg-2 col-md-3 col-sm-6 mb-3">
                <div class="stat-card text-center" data-bs-toggle="tooltip" data-bs-placement="top" 
                     title="AI Development Enablement Index: Composite score measuring adoption rate (@((aideiMetrics.AdoptionRate * 100).ToString("F1"))%, weight: 40%), acceptance rate (@((aideiMetrics.AcceptanceRate * 100).ToString("F1"))%, weight: 40%), and licensed vs engaged rate (@((aideiMetrics.LicensedVsEngagedRate * 100).ToString("F1"))%, weight: 20%). Overall score: @((aideiMetrics.AIDEIScore * 100).ToString("F1"))">
                    <div class="stat-value">@aideiMetrics.AIDEIScore.ToString("F1")</div>
                    <div class="stat-label">AIDEI Score</div>
                    <small class="stat-description">
                        <button class="btn btn-link p-0 text-decoration-none" style="font-size: inherit; color: inherit;" 
                                @onclick="() => showAIDEIBreakdown = !showAIDEIBreakdown">
                            @(showAIDEIBreakdown ? "Hide" : "Show") breakdown
                        </button>
                    </small>
                </div>
                
                @if (showAIDEIBreakdown)
                {
                    <div class="mt-2 small">
                        <div class="row g-1">
                            <div class="col-12">
                                <div class="d-flex justify-content-between">
                                    <span>Adoption (@((aideiMetrics.AdoptionRate * 100).ToString("F1"))%)</span>
                                    <span class="text-muted">×40%</span>
                                </div>
                                <div class="progress" style="height: 4px;">
                                    <div class="progress-bar bg-primary" style="width: @((aideiMetrics.AdoptionRate * 100).ToString("F1"))%"></div>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="d-flex justify-content-between">
                                    <span>Acceptance (@((aideiMetrics.AcceptanceRate * 100).ToString("F1"))%)</span>
                                    <span class="text-muted">×40%</span>
                                </div>
                                <div class="progress" style="height: 4px;">
                                    <div class="progress-bar bg-success" style="width: @((aideiMetrics.AcceptanceRate * 100).ToString("F1"))%"></div>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="d-flex justify-content-between">
                                    <span>Engagement (@((aideiMetrics.LicensedVsEngagedRate * 100).ToString("F1"))%)</span>
                                    <span class="text-muted">×20%</span>
                                </div>
                                <div class="progress" style="height: 4px;">
                                    <div class="progress-bar bg-info" style="width: @((aideiMetrics.LicensedVsEngagedRate * 100).ToString("F1"))%"></div>
                                </div>
                            </div>
                            <div class="col-12 mt-1 pt-1 border-top">
                                <div class="d-flex justify-content-between fw-bold">
                                    <span>AIDEI Score</span>
                                    <span>@((aideiMetrics.AIDEIScore * 100).ToString("F1"))</span>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
            <div class="col-lg-2 col-md-3 col-sm-6 mb-3">
                <div class="stat-card text-center" data-bs-toggle="tooltip" data-bs-placement="top" 
                     title="Average % of working days (Mon-Fri) that active users used Copilot with 3+ activities. Measures consistency of usage across the work week.">
                    <div class="stat-value">@(engineeringMetrics.UsageRate.ToString("P1"))</div>
                    <div class="stat-label">Usage Rate</div>
                    <small class="stat-description">Avg working day usage</small>
                </div>
            </div>
            <div class="col-lg-2 col-md-3 col-sm-6 mb-3">
                <div class="stat-card text-center" data-bs-toggle="tooltip" data-bs-placement="top" 
                     title="% of licensed seats with ANY activity in the selected date range. Measures how many users tried Copilot at least once.">
                    <div class="stat-value">@(engineeringMetrics.LicenseUtilization.ToString("P1"))</div>
                    <div class="stat-label">License Utilization</div>
                    <small class="stat-description">Seats with any usage</small>
                </div>
            </div>
            <div class="col-lg-2 col-md-3 col-sm-6 mb-3">
                <div class="stat-card text-center" data-bs-toggle="tooltip" data-bs-placement="top" 
                     title="Number of licensed seats that are not being actively used - potential cost optimization opportunity">
                    <div class="stat-value">@engineeringMetrics.UnusedSeats</div>
                    <div class="stat-label">Unused Seats</div>
                    <small class="stat-description">Potential savings</small>
                </div>
            </div>
            <div class="col-lg-2 col-md-3 col-sm-6 mb-3">
                <div class="stat-card text-center" data-bs-toggle="tooltip" data-bs-placement="top" 
                     title="% of licensed users with meaningful engagement: 5+ activities on at least 2 days in the selected period. Uses calendar days.">
                    <div class="stat-value">@(engineeringMetrics.EngagedUsersPercent.ToString("P1"))</div>
                    <div class="stat-label">Engaged Users</div>
                    <small class="stat-description">2+ active days</small>
                </div>
            </div>
            <div class="col-lg-2 col-md-3 col-sm-6 mb-3">
                <div class="stat-card text-center" data-bs-toggle="tooltip" data-bs-placement="top" 
                     title="% of active users with 30%+ acceptance rate AND 3+ active days. Identifies highly proficient users.">
                    <div class="stat-value">@(engineeringMetrics.PowerUsersPercent.ToString("P1"))</div>
                    <div class="stat-label">Power Users</div>
                    <small class="stat-description">High proficiency users</small>
                </div>
            </div>
        </div>
        <div class="row mb-4">
            <div class="col-lg-4 col-md-6 mb-3">
                <div class="stat-card text-center" data-bs-toggle="tooltip" data-bs-placement="top" 
                     title="Estimated monetary value of developer productivity saved through Copilot usage. Calculated as: Time Saved × Cost per Hour. Based on working days.">
                    <div class="stat-value">$@(((engineeringMetrics.EstimatedTimeSavedHours * costPerHour)).ToString("N0"))</div>
                    <div class="stat-label">Productivity Cost Savings</div>
                    <small class="stat-description">@(engineeringMetrics.EstimatedTimeSavedHours.ToString("N0"))h × $@(costPerHour)/hr (working days)</small>
                </div>
            </div>
        </div>
    </div>

    <!-- AIDEI Detailed Metrics Section -->
    <div class="card mb-4">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h4 class="mb-0">AIDEI Detailed Metrics</h4>
          <small class="text-muted">AI Development Enablement Index</small>
        </div>
        
        <div class="row g-3 mb-4">
          <div class="col-md-2 offset-md-1">
            <div class="stat-card" data-bs-toggle="tooltip" data-bs-placement="top" 
                 title="Composite AI Development Enablement Index score combining Adoption Rate (40%), Acceptance Rate (40%), and Licensed vs Engaged Rate (20%). Scale: 0 to 100">
              <div class="stat-value">@((aideiMetrics.AIDEIScore * 100).ToString("F1"))</div>
              <div class="stat-label">AIDEI Score</div>
            </div>
          </div>
          <div class="col-md-2">
            <div class="stat-card" data-bs-toggle="tooltip" data-bs-placement="top" 
                 title="% of total licensed users who have ANY Copilot activity (interactions or code generations) in the selected date range">
              <div class="stat-value">@aideiMetrics.AdoptionRate.ToString("P1")</div>
              <div class="stat-label">Adoption Rate</div>
              <small class="text-muted">Any activity vs licenses</small>
            </div>
          </div>
          <div class="col-md-2">
            <div class="stat-card" data-bs-toggle="tooltip" data-bs-placement="top" 
                 title="Activity-Based Acceptance Rate: Measures acceptance at the activity session level. This differs from GitHub's official Suggestion-Based metrics which count individual suggestions and partial acceptances.">
              <div class="stat-value">@aideiMetrics.AcceptanceRate.ToString("P1")</div>
              <div class="stat-label">Activity-Based Rate</div>
            </div>
          </div>
          <div class="col-md-2">
            <div class="stat-card" data-bs-toggle="tooltip" data-bs-placement="top" 
                 title="% of total licensed users with meaningful daily engagement (5+ activities on at least 2 calendar days). Represents true productivity usage.">
              <div class="stat-value">@aideiMetrics.LicensedVsEngagedRate.ToString("P1")</div>
              <div class="stat-label">Licensed vs Engaged</div>
              <small class="text-muted">Meaningful users</small>
            </div>
          </div>
          <div class="col-md-2">
            <div class="stat-card" data-bs-toggle="tooltip" data-bs-placement="top" 
                 title="Letter grade representation of AIDEI Score: A+ (90+), A (80+), B+ (70+), B (60+), C+ (50+), C (40+), D (30+), F (below 30)">
              <div class="stat-value">@GetAIDEIGrade()</div>
              <div class="stat-label">AIDEI Grade</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Advanced Engineering Metrics -->
    <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0 text-secondary">
                <span class="oi oi-graph" aria-hidden="true"></span>
                Advanced Engineering Metrics
            </h4>
            <button class="btn btn-outline-primary btn-sm" @onclick="() => showAdvancedMetrics = !showAdvancedMetrics">
                <span class="oi @(showAdvancedMetrics ? "oi-chevron-top" : "oi-chevron-bottom")" aria-hidden="true"></span>
                @(showAdvancedMetrics ? "Hide" : "Show") Details
            </button>
        </div>
        
        @if (showAdvancedMetrics)
        {
            <div class="row">
                <div class="col-md-3 mb-3">
                    <div class="stat-card" data-bs-toggle="tooltip" data-bs-placement="top" 
                         title="The middle value of acceptance rates across all users. More stable than average acceptance rate as it's not skewed by outliers. Indicates typical suggestion quality.">
                        <div class="stat-value">@(engineeringMetrics.MedianAcceptanceRate.ToString("P1"))</div>
                        <div class="stat-label">Median Acceptance Rate</div>
                        <small class="text-muted">Quality indicator</small>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="stat-card" data-bs-toggle="tooltip" data-bs-placement="top" 
                         title="Average code suggestions accepted per active user per working day (Mon-Fri). Higher values indicate better individual productivity and engagement.">
                        <div class="stat-value">@(engineeringMetrics.AcceptancesPerActiveUserPerDay.ToString("F1"))</div>
                        <div class="stat-label">Daily Acceptances/User</div>
                        <small class="text-muted">Per working day</small>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="stat-card" data-bs-toggle="tooltip" data-bs-placement="top" 
                         title="Percentage of code generations that come from inline code completion features vs other features. Shows preference for seamless, context-aware coding assistance.">
                        <div class="stat-value">@(engineeringMetrics.InlineSharePercent.ToString("P1"))</div>
                        <div class="stat-label">Inline Usage</div>
                        <small class="text-muted">Feature adoption</small>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="stat-card" data-bs-toggle="tooltip" data-bs-placement="top" 
                         title="Percentage of active users who have used GitHub Copilot Chat features. Indicates adoption of conversational AI for problem-solving and code explanation.">
                        <div class="stat-value">@(engineeringMetrics.ChatAdoptionPercent.ToString("P1"))</div>
                        <div class="stat-label">Chat Adoption</div>
                        <small class="text-muted">AI interaction</small>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="stat-card" data-bs-toggle="tooltip" data-bs-placement="top" 
                         title="Difference between the best-performing AI model's acceptance rate and the overall average. Higher margins indicate clear model preferences and quality differences.">
                        <div class="stat-value">@(engineeringMetrics.ModelLeaderMargin.ToString("P1"))</div>
                        <div class="stat-label">Model Leader Margin</div>
                        <small class="text-muted">Distribution metric</small>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="stat-card" data-bs-toggle="tooltip" data-bs-placement="top" 
                         title="Gini coefficient measuring inequality in Copilot usage distribution. 0 = perfectly equal usage, 1 = highly concentrated. Values >0.5 suggest few power users dominate.">
                        <div class="stat-value">@(engineeringMetrics.ConcentrationIndex.ToString("F2"))</div>
                        <div class="stat-label">Usage Concentration</div>
                        <small class="text-muted">Gini coefficient</small>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="stat-card" data-bs-toggle="tooltip" data-bs-placement="top" 
                         title="Average number of new users adopting Copilot per week over the last 4 weeks. Indicates the velocity of organic adoption within your organization.">
                        <div class="stat-value">@(engineeringMetrics.RampRateUsersPerWeek.ToString("F1"))</div>
                        <div class="stat-label">Weekly Growth Rate</div>
                        <small class="text-muted">New users/week</small>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="stat-card" data-bs-toggle="tooltip" data-bs-placement="top" 
                         title="Median number of days from a user's first Copilot interaction to their first code acceptance. Lower values indicate faster onboarding and value realization.">
                        <div class="stat-value">@(engineeringMetrics.TimeToFirstValueDays.ToString("F1"))</div>
                        <div class="stat-label">Time to First Value</div>
                        <small class="text-muted">Days to adoption</small>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="stat-card" data-bs-toggle="tooltip" data-bs-placement="top" 
                         title="Percentage of programming languages supported by Copilot that are actively being used by your team. Higher coverage indicates diverse technology adoption.">
                        <div class="stat-value">@(engineeringMetrics.LanguageCoveragePercent.ToString("P1"))</div>
                        <div class="stat-label">Language Coverage</div>
                        <small class="text-muted">Supported languages</small>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="stat-card" data-bs-toggle="tooltip" data-bs-placement="top" 
                         title="Estimated developer hours saved based on total code acceptances × configurable time per acceptance (default: 30 seconds). Provides ROI calculation for Copilot investment.">
                        <div class="stat-value">@(engineeringMetrics.EstimatedTimeSavedHours.ToString("N0"))h</div>
                        <div class="stat-label">Time Saved (Est.)</div>
                        <small class="text-muted">Productivity gain</small>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="stat-card" data-bs-toggle="tooltip" data-bs-placement="top" 
                         title="The AI model with the highest number of code generations across all users. Shows which model is most utilized in your organization.">
                        <div class="stat-value">@(mostUsedModel.Model)</div>
                        <div class="stat-label">Most Used Model</div>
                        <small class="text-muted">@(mostUsedModel.Generations.ToString("N0")) generations</small>
                    </div>
                </div>
            </div>
        }
    </div>

    <Filters OnChanged="OnFiltersChanged" />

    <div class="row g-4">
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">
                        <span class="oi oi-people" aria-hidden="true"></span> Adoption
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6 col-md-3 mb-3">
                            <div class="stat-card stat-card-with-sparkline" data-bs-toggle="tooltip" data-bs-placement="top" 
                                 title="Total number of unique users who have any recorded Copilot activity (interactions or code generations)">
                                <div class="stat-main">
                                    <div class="stat-value">@adoption.ActiveUsers</div>
                                    <div class="stat-label">Active Users</div>
                                </div>
                                <div class="sparkline-container">
                                    <canvas id="activeUsersSparkline"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3 mb-3">
                            <div class="stat-card" data-bs-toggle="tooltip" data-bs-placement="top" 
                                 title="Number of users who have used GitHub Copilot Chat features (chat panel, inline chat, or ask mode)">
                                <div class="stat-value">@adoption.UsingChat</div>
                                <div class="stat-label">Using Chat</div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3 mb-3">
                            <div class="stat-card" data-bs-toggle="tooltip" data-bs-placement="top" 
                                 title="Number of users who have used GitHub Copilot inline features like inline chat and contextual suggestions">
                                <div class="stat-value">@adoption.UsingInline</div>
                                <div class="stat-label">Using Inline</div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3 mb-3">
                            <div class="stat-card" data-bs-toggle="tooltip" data-bs-placement="top" 
                                 title="Number of users who have used GitHub Copilot code completion features for automatic code suggestions">
                                <div class="stat-value">@adoption.UsingCompletions</div>
                                <div class="stat-label">Using Completions</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">
                        <span class="oi oi-dashboard" aria-hidden="true"></span> Usage Totals
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6 col-md-3 mb-3">
                            <div class="stat-card" data-bs-toggle="tooltip" data-bs-placement="top" 
                                 title="Total number of user interactions with Copilot across all features (chat messages, completion requests, etc.)">
                                <div class="stat-value">@totals.Interactions.ToString("N0")</div>
                                <div class="stat-label">Interactions</div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3 mb-3">
                            <div class="stat-card" data-bs-toggle="tooltip" data-bs-placement="top" 
                                 title="Total number of AI-generated code suggestions and completions provided by Copilot to users">
                                <div class="stat-value">@totals.Generations.ToString("N0")</div>
                                <div class="stat-label">Generations</div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3 mb-3">
                            <div class="stat-card" data-bs-toggle="tooltip" data-bs-placement="top" 
                                 title="Total number of AI-generated code suggestions that developers accepted and incorporated into their code">
                                <div class="stat-value">@totals.Acceptances.ToString("N0")</div>
                                <div class="stat-label">Acceptances</div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3 mb-3">
                            <div class="stat-card stat-card-with-sparkline" data-bs-toggle="tooltip" data-bs-placement="top" 
                                 title="Activity-Based Acceptance Rate: Percentage of code generation activities that resulted in code acceptance (Activity Sessions). This differs from GitHub's Suggestion-Based rate which counts individual suggestions. Activity-based rates are typically lower as one session may contain multiple suggestions.">
                                <div class="stat-main">
                                    <div class="stat-value">@totals.AcceptanceRate.ToString("P1")</div>
                                    <div class="stat-label">Activity-Based Rate</div>
                                    <small class="text-muted">Session-level metric</small>
                                </div>
                                <div class="sparkline-container">
                                    <canvas id="acceptanceRateSparkline"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-4">
        <Charts RefreshKey="@refreshKey" />
    </div>

    <!-- Metrics Methodology Note -->
    <div class="mt-4 mb-4">
        <button class="btn btn-outline-info mb-2" type="button" data-bs-toggle="collapse" data-bs-target="#methodologyNote" aria-expanded="false" aria-controls="methodologyNote">
            <i class="oi oi-info" aria-hidden="true"></i> Metrics Methodology Note
        </button>
        <div class="collapse" id="methodologyNote">
            <div class="alert alert-info" role="alert">
                <h6 class="alert-heading">
                    <i class="oi oi-info" aria-hidden="true"></i> About Our Metrics Methodology
                </h6>
                <div class="row">
                    <div class="col-md-6">
                        <p class="mb-2"><strong>This Dashboard (Activity-Based):</strong></p>
                        <ul class="mb-2">
                            <li>Measures interaction <strong>sessions</strong> or <strong>activity periods</strong></li>
                            <li>Uses GitHub's Usage API data</li>
                            <li>One activity can contain multiple suggestions</li>
                            <li>Typically shows <strong>lower</strong> acceptance rates</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-2"><strong>GitHub Official Dashboard (Suggestion-Based):</strong></p>
                        <ul class="mb-2">
                            <li>Measures <strong>individual</strong> code suggestions</li>
                            <li>Uses GitHub's Metrics API data</li>
                            <li>Includes partial acceptances as full acceptances</li>
                            <li>Typically shows <strong>higher</strong> acceptance rates</li>
                        </ul>
                    </div>
                </div>
                <p class="mb-0">
                    <small class="text-muted">
                        <strong>Example:</strong> If a user receives 5 suggestions in one coding session and accepts 3 of them:
                        Activity-Based = 1 generation activity, 1 acceptance activity = 100% rate | 
                        Suggestion-Based = 5 suggestions, 3 acceptances = 60% rate
                    </small>
                </p>
            </div>
        </div>
    </div>

    <div class="mt-4">
        <DataTable RefreshKey="@refreshKey" />
    </div>
}


@code {
		private int loadedCount;
		private DateOnly minDate, maxDate;
	private int refreshKey = 0;
	private DataService.AdoptionStats adoption = new(0,0,0,0);
	private DataService.Totals totals = new(0,0,0);
	private DataService.AIDEIMetrics aideiMetrics = new(0,0,0,0,0);
	private DataService.EngineeringMetrics engineeringMetrics = new(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);
	private (string Model, int Generations) mostUsedModel = ("", 0);
	private string? loadError;
	private bool isLoading = false;
	private int progressRecords = 0;
	private long progressBytes = 0;
	private long totalBytes = 0;
	private int progressPercent => totalBytes > 0 ? (int)Math.Min(100, Math.Round(progressBytes * 100.0 / totalBytes)) : 0;
	private string progressBytesDisplay => FormatBytes(progressBytes);
	private string totalBytesDisplay => totalBytes > 0 ? FormatBytes(totalBytes) : "unknown";
	private bool loadAttempted = false;
	private int totalLicensedUsers = 0;
	private bool showAdvancedMetrics = false;
	private bool showAIDEIBreakdown = false;
	private bool showSettings = false;
	
	// Configuration settings with change notifications
	private int _timeSavedPerAcceptanceSeconds = 30;
	private int timeSavedPerAcceptanceSeconds
	{
		get => _timeSavedPerAcceptanceSeconds;
		set
		{
			if (_timeSavedPerAcceptanceSeconds != value)
			{
				_timeSavedPerAcceptanceSeconds = value;
				_ = Task.Run(OnSettingsChanged);
			}
		}
	}
	
	private double _powerUserAcceptanceThreshold = 0.3;
	private double powerUserAcceptanceThreshold
	{
		get => _powerUserAcceptanceThreshold;
		set
		{
			if (Math.Abs(_powerUserAcceptanceThreshold - value) > 0.001)
			{
				_powerUserAcceptanceThreshold = value;
				_ = Task.Run(OnSettingsChanged);
			}
		}
	}
	
	private int _powerUserActiveDaysThreshold = 3;
	private int powerUserActiveDaysThreshold
	{
		get => _powerUserActiveDaysThreshold;
		set
		{
			if (_powerUserActiveDaysThreshold != value)
			{
				_powerUserActiveDaysThreshold = value;
				_ = Task.Run(OnSettingsChanged);
			}
		}
	}
	
	private int _engagementThreshold = 5;
	private int engagementThreshold
	{
		get => _engagementThreshold;
		set
		{
			if (_engagementThreshold != value)
			{
				_engagementThreshold = value;
				_ = Task.Run(OnSettingsChanged);
			}
		}
	}
	
	private int _costPerHour = 90;
	private int costPerHour
	{
		get => _costPerHour;
		set
		{
			if (_costPerHour != value)
			{
				_costPerHour = value;
				_ = Task.Run(OnSettingsChanged);
			}
		}
	}
	
	private async Task OnFileSelected(InputFileChangeEventArgs e)
		{
				var file = e.File;
				try
				{
					loadAttempted = true;
					Console.WriteLine($"File selected: {file.Name}, Size: {file.Size} bytes");
					isLoading = true; progressRecords = 0; progressBytes = 0; totalBytes = file.Size;
					loadError = null;
					StateHasChanged();
					
					var prog = new Progress<(int Records, long BytesRead)>(tuple => { 
						Console.WriteLine($"Progress: {tuple.Records} records, {tuple.BytesRead} bytes");
						progressRecords = tuple.Records; progressBytes = tuple.BytesRead; StateHasChanged(); 
					});
					// Allow up to 100 MB to cover typical NDJSON exports on Blazor Server
					await using var stream = file.OpenReadStream(1024 * 1024 * 100);
					Console.WriteLine("Starting to load NDJSON...");
					await Data.LoadNdjsonAsync(stream, prog);
					Console.WriteLine($"Loaded {Data.Records.Count} records");
					loadError = null;
					AfterLoad();
				}
				catch (Exception ex)
				{
					Console.WriteLine($"Error loading file: {ex}");
					loadError = $"Failed to load file: {ex.Message}";
				}
				finally
				{
					isLoading = false;
					StateHasChanged();
				}
		}

		private async Task LoadSample()
		{
				loadAttempted = true;
				// Try to load the workspace JSON at repo root
				var baseDir = AppContext.BaseDirectory;
				string MakePath(params string[] parts) => Path.GetFullPath(Path.Combine([baseDir, ..Enumerable.Repeat("..", 4), ..parts]));

				// Known candidate sample files at repo root
				var candidates = new[]
				{
					MakePath("72b2660a-bc2e-4182-94e9-1a4e76b778f9_1_da37129b6ab241fda4179249fc33f57a.json"),
					MakePath("test-sample.json")
				};

				var path = candidates.FirstOrDefault(File.Exists);
				if (path is not null)
				{
						try
						{
							isLoading = true; progressRecords = 0; progressBytes = 0; totalBytes = new FileInfo(path).Length;
							loadError = null;
							StateHasChanged();
							var prog = new Progress<(int Records, long BytesRead)>(tuple => { progressRecords = tuple.Records; progressBytes = tuple.BytesRead; StateHasChanged(); });
							await using var fs = File.OpenRead(path);
							await Data.LoadNdjsonAsync(fs, prog);
							AfterLoad();
						}
						catch (Exception ex)
						{
							loadError = $"Failed to load workspace file: {ex.Message}";
						}
						finally
						{
							isLoading = false;
							StateHasChanged();
						}
				}
				else
				{
                    loadError = $"Sample file not found. Tried: {string.Join(", ", candidates)}";
                    StateHasChanged();
                }
		}

	private void OnFiltersChanged()
		{
				adoption = Data.GetAdoption();
			totals = Data.GetTotals();
			aideiMetrics = Data.GetAIDEI();
			engineeringMetrics = Data.GetEngineeringMetrics();
			mostUsedModel = Data.GetMostUsedModel();
		refreshKey++;
				StateHasChanged();
				// Reinitialize tooltips after state change
				_ = InvokeAsync(() => JS.InvokeVoidAsync("initializeTooltips"));
				// Render sparklines after state change
				_ = InvokeAsync(RenderSparklines);
		}

		private async Task RenderSparklines()
		{
			try
			{
				var ts = Data.GetTimeSeries().ToList();
				if (ts.Any())
				{
					// Calculate daily unique active users
					var activeUsersData = ts.Select(point => 
						Data.GetFiltered()
							.Where(r => r.Day == point.Day)
							.Select(r => r.UserLogin)
							.Distinct(StringComparer.OrdinalIgnoreCase)
							.Count()
					).ToArray();

					// Calculate daily acceptance rates
					var acceptanceRateData = ts.Select(point => 
						point.Generations > 0 ? (double)point.Acceptances / point.Generations * 100 : 0
					).ToArray();

					await JS.InvokeVoidAsync("copilotCharts.sparkline", "activeUsersSparkline", activeUsersData, "#2b6c70");
					await JS.InvokeVoidAsync("copilotCharts.sparkline", "acceptanceRateSparkline", acceptanceRateData, "#005358");
				}
			}
			catch (Exception ex)
			{
				Console.WriteLine($"Error rendering sparklines: {ex.Message}");
			}
		}

	private void AfterLoad()
		{
				loadedCount = Data.Records.Count;
				if (loadedCount > 0)
				{
						minDate = Data.Records.Min(r => r.Day);
						maxDate = Data.Records.Max(r => r.Day);
				}
				OnFiltersChanged();
		}

		private static string FormatBytes(long bytes)
		{
			string[] units = ["B", "KB", "MB", "GB", "TB"]; int i = 0; double val = bytes;
			while (val >= 1024 && i < units.Length - 1) { val /= 1024; i++; }
			return $"{val:0.##} {units[i]}";
		}

		private void OnLicensedUsersChanged()
		{
			// Update the total licensed users in the data service
			Data.SetTotalLicensedUsers(totalLicensedUsers);
			// Recalculate adoption stats based on the new licensed users count
			OnFiltersChanged();
		}
		
		private string GetAIDEIGrade()
		{
			var score = aideiMetrics.AIDEIScore * 100;
			return score switch
			{
				>= 90 => "A+",
				>= 80 => "A",
				>= 70 => "B+",
				>= 60 => "B",
				>= 50 => "C+",
				>= 40 => "C",
				>= 30 => "D",
				_ => "F"
			};
		}
		
		private void ToggleSettings()
		{
			showSettings = !showSettings;
			StateHasChanged();
		}
		
		private async Task OnSettingsChanged()
		{
			// Update DataService with new settings
			Data.SecondsPerAcceptance = timeSavedPerAcceptanceSeconds;
			Data.PowerUserAcceptanceThreshold = powerUserAcceptanceThreshold;
			Data.PowerUserActiveDaysThreshold = powerUserActiveDaysThreshold;
			Data.EngagementThreshold = engagementThreshold;
			
			// Recalculate metrics with new settings on UI thread
			await InvokeAsync(() => {
				OnFiltersChanged();
			});
		}
		
		private async Task OnTimeSavedChanged(ChangeEventArgs e)
		{
			if (int.TryParse(e.Value?.ToString(), out int value))
			{
				timeSavedPerAcceptanceSeconds = value;
				await OnSettingsChanged();
			}
		}
		
		private async Task OnPowerUserAcceptanceChanged(ChangeEventArgs e)
		{
			if (double.TryParse(e.Value?.ToString(), out double value))
			{
				powerUserAcceptanceThreshold = value;
				await OnSettingsChanged();
			}
		}
		
		private async Task OnPowerUserDaysChanged(ChangeEventArgs e)
		{
			if (int.TryParse(e.Value?.ToString(), out int value))
			{
				powerUserActiveDaysThreshold = value;
				await OnSettingsChanged();
			}
		}
		
		private async Task OnEngagementThresholdChanged(ChangeEventArgs e)
		{
			if (int.TryParse(e.Value?.ToString(), out int value))
			{
				engagementThreshold = value;
				await OnSettingsChanged();
			}
		}
		
		private async Task OnCostPerHourChanged(ChangeEventArgs e)
		{
			if (int.TryParse(e.Value?.ToString(), out int value))
			{
				costPerHour = value;
				await OnSettingsChanged();
			}
		}
}

<script>
    // Initialize Bootstrap tooltips after the page loads
    document.addEventListener('DOMContentLoaded', function () {
        initializeTooltips();
    });
    
    // Function to initialize/reinitialize tooltips
    window.initializeTooltips = function() {
        // Dispose existing tooltips first to avoid memory leaks
        var existingTooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        existingTooltips.forEach(function(el) {
            var tooltip = bootstrap.Tooltip.getInstance(el);
            if (tooltip) {
                tooltip.dispose();
            }
        });
        
        // Initialize new tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl, {
                trigger: 'hover focus'
            });
        });
    };
    
    // Reinitialize tooltips after Blazor updates (called from C#)
    Blazor.addEventListener('enhancedload', function () {
        setTimeout(initializeTooltips, 100);
    });
</script>
